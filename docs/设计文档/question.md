# 大规模网盘系统

## 介绍一下这个项目
1. 【概述】这个项目是使用c++实现的网盘服务器，支持了一些用户常规操作，并针对网络链接和数据传输进行了一些优化
2. 最好打开项目架构图
3. 服务器根据客户端操作的不同场景，使用短链接和长链接进行交互（长链接短链接在不同的端口），这里我先介绍短链接部分
4. 【短链接】使用的是TCP+socket
    - 服务器启动时会先启动一个线程池，这个线程池用户处理具体用户请求，主线程和线程池直接通过管道进行通信也就是这里的pipe_fd，支线程通过监听管道的读端判断时候有事件需要处理。
    - 服务器的主线程监听客户端链接事件，当请求到达时进行accept建立链接，而后将accept返回的文件描述符通过写入管道发送给支线程，交给支线程处理。主线程继续等待下一个客户端链接。
    - 支线程拿到标识该链接的文件描述符后进行具体的业务处理，这里在设计时使用了MVC的设计模式
        - Model：客户端和服务器间使用json传输数据，这里解包后可以根据Type字段拿到当前客户端的操作类型，如：注册、登录、退出等
        - Control：虚拟的控制组件，可以根据Model的类型将数据发送给不同的视图
        - View：具体每种视图的操作方式，view 的基类封装了通用操作的接口如mysql、文件操作，后续实现具体操作业务逻辑时只需要继承View的基类，并实现Process方法即可。
    - 具体操作流程可以设计文档3.1 view流程，以注册视图为例：检查用户名是否存在，创建Usr表中的一行填充name passwd，创建用户目录，返回repsonse客户端响应注册结果
5. 【长链接】使用的是BRPC
    - 长链接只处理文件的上传和下载，分别在客户端和服务器实现对应的函数即可
6. 考虑到上传下载的优化文件妙传、断点续传、多点下载和下载提速，对传输流程和文件存储方式都做了特殊的设计，如果需要再详细说。

## 为什么使用短链接和长链接（重点）
1. 分析长链接短链接各自的优势及劣势
【短链接】
- 优点：
    - Linux原生的网路传输协议，可以支持几乎所有的网络配置的修改十分灵活
    - 直接使用TCP协议进行传输，可以最小代价地保证传输地可靠性。
    - 可以针对网盘的各种大文件定制文件压缩方式，降低带宽的使用，提高传输速度。
- 缺点：
    - 每条链接都需要创建socket，读取数据流后解析，业务逻辑和网络协议嵌套，代码复杂度提升
    - 上传文件的时间较长，需要保持长连接。大量的长连接会对服务器造成巨大压力，所以必须要先完善链接的管理方式、心跳包等逻辑，工作量较大。
【长链接】
- 优点：
    - 屏蔽了底层协议、长链接管理等问题，使用起来更加简单。后期升级server业务代码改动方便。
    - 使用protobuf进行序列化，对字符串会自动进行压缩，可以满足当前业务场景。
    - 提供了cpu heap profiles和其他一些易用的组件
    - 可以直接使用bvar mbvar 进行服务监控
- 缺点：
    - 相比直接使用socket，性能会有损失，并且在极致的性能调优时会出现瓶颈
2. 总结本项目更适合那种方案
综上：考虑到在带宽普遍小于1G的机器上，秒级别的上传时间可以忽略毫秒级别socket带来的优化。
鉴于排期和代码实现复杂度，用少量的性能损失换取代码良好的抽象封装和代码可读性是十分划算的，所以对两个方案进行融合
对于用户注册登录等低频并且能立刻返回结果的操作使用socket进行处理，上传、下载文件使用RPC托管长连接。

## 既然使用rpc更好，为什么不直接使用rpc
前期方案设计的时候未考虑到长链接的管理，基于Linux scoket编程及epoll模式比较熟悉就没有使用rpc了，后续了解brpc后尝试加入到项目中了。

## 长链接相比短链接有什么好处
todo：

## 除了MVC设计模式，还了解哪些设计模式
todo：单例、工厂、xxxx

## 进程间通信方式有哪些（重点）
todo：

## 为什么使用线程池/线程池有什么好处（重点）
todo：

## 有哪些IO模型（重点）
todo：

## 如何理解项目中半同步半异步网络模型（重点）
1. 解释什么是同步，什么是异步
todo：
2. 在这个项目中，同步指主线程循环accept请求，但是accept之后的处理是交给支线程的，此时主线程是可以继续accept新链接，所以从消息处理的角度看支线程的行为是异步的。

## 介绍下libevent


## select、poll、epoll区别（重点）
todo：

## 项目中mysql 有哪些表


## mysql表的引擎是哪两种，有什么区别
todo：

## mysql四种隔离级别，怎么避免（重要）

## 除了msql还了解什么数据库
【redis】介绍、aof、rdb
【TSDB】

## 文件上传、下载流程（重点）
【上传】
【下载】

# 分布式可观测建设

## 介绍一下这个项目


## RequestCounter 解决什么问题


## RequestCounter 怎么实现的
